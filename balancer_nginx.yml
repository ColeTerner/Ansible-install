- name: NGINX as BALANCER
  hosts:  all
  vars:
    upstream_group: zayl_app
    redirect_to:  192.168.10.95:80
    nginx_balancer_port:  8888
  become: yes
  tags: balancer
  tasks:

    # - name: test nginx config
    #   shell:  nginx -t
    #   register: nginx_check
    # - debug:  var=nginx_check.stdout_lines

    - name: copy old /etc/nginx/nginx.conf -> ~$USER/nginx.conf.bak
      copy:
        src:  /etc/nginx/nginx.conf
        dest: /home/{{ansible_user}}/nginx.conf.balancer.bak
        remote_src: yes


    - name: Add block
      blockinfile:
        path: /etc/nginx/nginx.conf
        state: present
        insertafter: "^http {.*"
        block: |2
            upstream {{upstream_group}} {
            server {{redirect_to}};
            }

            server {
            listen {{nginx_balancer_port}};
            location / {
            proxy_pass http://{{upstream_group}};
            }
            }
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
      become: yes
      
    - name: check nginx config
      shell:  sudo nginx -t
      ignore_errors:  yes

    - name: restart nginx
      systemd:
        name: nginx
        state:  restarted

    - name: ufw enabled
      ufw:
        state:  enabled
    
    - name: ufw allow http, https
      ufw:
        rule: allow
        proto:  tcp
        port: '{{item}}'
      with_items:
        - 80
        - 443
        - 22
        - '{{nginx_balancer_port}}'
    
    - name: check balancer work
      shell:  curl -I http://{{ansible_host}}:{{nginx_balancer_port}}
      register: check
    - debug:  var=check.stdout_lines
